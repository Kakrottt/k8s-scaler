apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: generalscalers.scaling.devsecops.ai
spec:
  group: scaling.devsecops.ai
  scope: Namespaced
  names:
    kind: GeneralScaler
    plural: generalscalers
    singular: generalscaler
    shortNames:
      - gscaler
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: ["targetRef", "metric", "policy", "safety"]
              properties:
                targetRef:
                  type: object
                  description: "Target workload (Deployment) to scale"
                  required: ["apiVersion", "kind", "name"]
                  properties:
                    apiVersion:
                      type: string
                      default: "apps/v1"
                    kind:
                      type: string
                      enum: ["Deployment"]
                    name:
                      type: string
                metric:
                  type: object
                  description: "Metric plugin configuration"
                  required: ["plugin", "type"]
                  properties:
                    type:
                      type: string
                      enum: ["external", "queue", "latency", "business"]
                    plugin:
                      type: string
                      enum: ["prometheus", "pubsub", "redis"]
                    targetValue:
                      type: number
                      description: "Desired metric level (e.g. target latency in ms, queue per replica)"
                    params:
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
                      description: "Plugin-specific config (URL, queries, keys, etc.)"
                policy:
                  type: object
                  description: "Policy engine configuration"
                  required: ["type"]
                  properties:
                    type:
                      type: string
                      enum: ["slo", "cost"]
                    slo:
                      type: object
                      properties:
                        objective:
                          type: number
                          description: "SLO objective in metric units (e.g. 200 ms)"
                        windowSeconds:
                          type: integer
                          description: "Lookback / aggregation window"
                    cost:
                      type: object
                      properties:
                        maxMonthlyCost:
                          type: number
                        costPerReplicaPerHour:
                          type: number
                        metricTarget:
                          type: number
                safety:
                  type: object
                  required: ["minReplicas", "maxReplicas"]
                  properties:
                    minReplicas:
                      type: integer
                      minimum: 0
                    maxReplicas:
                      type: integer
                      minimum: 1
                    maxScaleUpStep:
                      type: integer
                      description: "Max replicas to add in one step"
                      default: 5
                    maxScaleDownStep:
                      type: integer
                      description: "Max replicas to remove in one step"
                      default: 5
                    cooldownSeconds:
                      type: integer
                      description: "Minimum seconds between scaling operations"
                      default: 60
            status:
              type: object
              properties:
                currentReplicas:
                  type: integer
                desiredReplicas:
                  type: integer
                lastScaleTime:
                  type: string
                  format: date-time
                lastScaleReason:
                  type: string
                lastMetricValue:
                  type: number
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
      subresources:
        status: {}
